<script>
import ChatButton from "src/components/ChatButton.vue";
import TitleBar from "src/components/TitleBar.vue";
import AddChatButton from "src/components/AddChatButton.vue";
import UpdateButton from "src/components/UpdateButton.vue";
import ImageButton from "src/components/ImageButton.vue";
import axios from 'axios';
import { openURL } from 'quasar';

export default {
  async mounted() {
    const apikey = localStorage.getItem(`api_key`);
    const showImage = localStorage.getItem(`image`);
    if (showImage) {
      this.showImage = showImage === "true";
    }
    if (apikey === null) {
      this.$router.push({ path: "/setup" });
    }
    const chats = localStorage.getItem("chats");
    if (chats) {
      this.chats = JSON.parse(chats);
    }
    await this.checkForUpdates();
  },
  components: {
    ChatButton,
    TitleBar,
    AddChatButton,
    UpdateButton,
    ImageButton,
  },
  data() {
    return {
      showImage: "",
      chats: [],
      addChat: false,
      chatname: "",
      name: "",
      update: false,
    };
  },
  methods: {
    onDeleteChat (chatname) {
      this.chats = this.chats.filter((chat) => chat !== chatname);
      localStorage.setItem("chats", JSON.stringify(this.chats));
      localStorage.removeItem(`messages-${chatname}`);
    },
    onUpdate() {
      openURL("https://github.com/DylanAkp/MaterialGPT/releases/latest");
    },
    onAddChat() {
      if (this.name === "") {
        return;
      }
      this.chats.push(this.name);
      console.log(this.name);
      localStorage.setItem("chats", JSON.stringify(this.chats));
      this.name = "";
    },
    compareVersions(v1, v2) {
      const v1Parts = v1.split('.').map(Number);
      const v2Parts = v2.split('.').map(Number);

      for (let i = 0; i < v1Parts.length; i++) {
          if (v1Parts[i] > v2Parts[i]) {
            return 1;
          } else if (v1Parts[i] < v2Parts[i]) {
            return -1;
          }
      }
      return 0;
    },
    async checkForUpdates() {
      try {
        const response = await axios.get(
          'https://api.github.com/repos/DylanAkp/MaterialGPT/releases'
        );
        const releases = response.data;
        if (releases && releases.length > 0) {
          const currentVersion = '1.2';
          const latestRelease = releases[0];
          const latestVersion = latestRelease.tag_name
          if (this.compareVersions(latestVersion, currentVersion) > 0) {
            this.update = true;
          }
        }
      }
      catch (error) {
        console.log(error);
      }
    },
  }
};
</script>

<template>
  <TitleBar></TitleBar>
    <ImageButton class="chats" v-if="this.showImage"></ImageButton>
    <div class="chats" v-for="chatname in chats" :key="chatname">
      <ChatButton :chatname="chatname" @delete="onDeleteChat"></ChatButton>
    </div>
  <AddChatButton class="button" @click="addChat = true" />
  <UpdateButton v-if="update" class="update" @click="onUpdate()"/>
  <div v-if="addChat">
    <q-dialog v-model="addChat" no-share="true" transition-show="slide-up">
      <div class="addchat">
        <h5>Create a new chat</h5>
        <input
          ref="messagebox"
          v-model="name"
          placeholder="Enter the chat name"
          class="placeholder"
        />
        <div class="bottom-btn">
        <q-btn
          v-close-popup
          icon="add"
          round
          flat
          color="#242f33"
          size="15px"
          class="add-btn"
          @click="onAddChat()">
          chat
        </q-btn>
      </div>
      </div>
    </q-dialog>
  </div>
</template>

<style scoped>

.bottom-btn {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-evenly;
  padding-top: 20px;
  width: 100%;
}

.add-btn {
  user-select: none;
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: space-evenly;
  background-color: #1e4c60;
  border-radius: 15px;
  height: 55px;
  width: 165px;
  color: #b0d5e8;
}

.placeholder {
  display: flex;
  align-content: center;
  border-radius: 25px;
  height: 45px;
  width: 80%;
  overflow: hidden !important;
  outline: none;
  padding-left: 10px;
  color: white;
  border-width: 0px !important;
  background-color: #1a1c1e;
}

.addchat {
  bottom: 10px;
  position: fixed;
  display: flex;
  background-color: #222a2e;
  border-radius: 30px !important;
  flex-direction: column;
  align-items: center;
  height: 250px;
  width: 95%;
}

.update {
  position: fixed;
  bottom: 20px;
  left: 20px;
}

.button {
  position: fixed;
  bottom: 20px;
  right: 20px;
}

.chats {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  width: 100%;
}
</style>
